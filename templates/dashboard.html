{% extends "base.html" %}

{% block title %}Traffic Dashboard - Kottakkal Smart Traffic{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Analytics Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="display-6 text-primary">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 class="card-title">{{ analytics.total_reports }}</h3>
                    <p class="card-text text-muted">Total Reports</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="display-6 text-danger">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h3 class="card-title">{{ analytics.active_incidents }}</h3>
                    <p class="card-text text-muted">Active Incidents</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="display-6 text-warning">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h5 class="card-title">{{ analytics.peak_congestion_time }}</h5>
                    <p class="card-text text-muted">Peak Hours</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card text-center">
                <div class="card-body">
                    <div class="display-6 text-info">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <h6 class="card-title">{{ analytics.most_congested_area }}</h6>
                    <p class="card-text text-muted">Hotspot Area</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-area me-2"></i>24-Hour Traffic Patterns
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="trafficChart" width="400" height="150"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Incident Types
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="incidentChart" width="200" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Zone Analysis -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-thermometer-half me-2"></i>Congestion Heatmap
                    </h6>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-circle text-danger me-2"></i>
                                <strong>AVS Junction</strong>
                                <br><small class="text-muted">Commercial hub area</small>
                            </div>
                            <div class="text-end">
                                <div class="progress" style="width: 100px;">
                                    <div class="progress-bar bg-danger" style="width: 85%"></div>
                                </div>
                                <small>85% congested</small>
                            </div>
                        </div>
                        
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-circle text-warning me-2"></i>
                                <strong>Temple Road</strong>
                                <br><small class="text-muted">Festival area</small>
                            </div>
                            <div class="text-end">
                                <div class="progress" style="width: 100px;">
                                    <div class="progress-bar bg-warning" style="width: 70%"></div>
                                </div>
                                <small>70% congested</small>
                            </div>
                        </div>
                        
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-circle text-warning me-2"></i>
                                <strong>Market Zone</strong>
                                <br><small class="text-muted">Shopping area</small>
                            </div>
                            <div class="text-end">
                                <div class="progress" style="width: 100px;">
                                    <div class="progress-bar bg-warning" style="width: 65%"></div>
                                </div>
                                <small>65% congested</small>
                            </div>
                        </div>
                        
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-circle text-success me-2"></i>
                                <strong>Almas Hospital</strong>
                                <br><small class="text-muted">Medical zone</small>
                            </div>
                            <div class="text-end">
                                <div class="progress" style="width: 100px;">
                                    <div class="progress-bar bg-success" style="width: 30%"></div>
                                </div>
                                <small>30% congested</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-parking me-2"></i>Smart Parking Status
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="card bg-success bg-opacity-10">
                                <div class="card-body py-3">
                                    <i class="fas fa-car display-6 text-success"></i>
                                    <h4 class="mt-2">67</h4>
                                    <p class="mb-0 small">Available Spots</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-6 mb-3">
                            <div class="card bg-danger bg-opacity-10">
                                <div class="card-body py-3">
                                    <i class="fas fa-ban display-6 text-danger"></i>
                                    <h4 class="mt-2">23</h4>
                                    <p class="mb-0 small">Occupied</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6>Nearby Areas:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-circle text-success me-2"></i>Market Complex - 12 spots</li>
                            <li><i class="fas fa-circle text-warning me-2"></i>Temple Parking - 8 spots</li>
                            <li><i class="fas fa-circle text-danger me-2"></i>Junction Plaza - Full</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Reports -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-list me-2"></i>Recent Traffic Reports
            </h5>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="filterReports('all')">All</button>
                <button class="btn btn-outline-warning" onclick="filterReports('active')">Active</button>
                <button class="btn btn-outline-success" onclick="filterReports('resolved')">Resolved</button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Severity</th>
                            <th>Status</th>
                            <th>Reporter</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTable">
                        {% for report in reports %}
                        <tr>
                            <td>
                                <small>{{ report.timestamp[:16] if report.timestamp else 'N/A' }}</small>
                            </td>
                            <td>
                                <i class="fas fa-{{ 'car-crash' if report.type == 'accident' else 'road' if report.type == 'pothole' else 'ban' if report.type == 'road_block' else 'users' if report.type == 'festival_crowd' else 'exclamation-triangle' }} me-1"></i>
                                {{ report.type|replace('_', ' ')|title }}
                            </td>
                            <td>{{ report.location }}</td>
                            <td>
                                <span class="badge bg-{{ 'danger' if report.severity == 'high' else 'warning' if report.severity == 'medium' else 'info' }}">
                                    {{ report.severity|title }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if report.status == 'resolved' else 'warning' }}">
                                    {{ report.status|title }}
                                </span>
                            </td>
                            <td>{{ report.reported_by }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Traffic patterns chart
const trafficPatterns = {{ traffic_patterns|tojson }};

const ctx = document.getElementById('trafficChart').getContext('2d');
const trafficChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: trafficPatterns.map(p => p.hour + ':00'),
        datasets: [{
            label: 'Average Traffic Level',
            data: trafficPatterns.map(p => p.level * 100),
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        }
    }
});

// Incident types chart
const incidentCtx = document.getElementById('incidentChart').getContext('2d');
const incidentChart = new Chart(incidentCtx, {
    type: 'doughnut',
    data: {
        labels: ['Traffic Jam', 'Accidents', 'Potholes', 'Road Blocks', 'Festival Crowds'],
        datasets: [{
            data: [35, 15, 20, 18, 12],
            backgroundColor: [
                '#FF6384',
                '#36A2EB',
                '#FFCE56',
                '#4BC0C0',
                '#9966FF'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 10,
                    usePointStyle: true
                }
            }
        }
    }
});

function filterReports(filter) {
    // Filter functionality for reports table
    const rows = document.querySelectorAll('#reportsTable tr');
    rows.forEach(row => {
        if (filter === 'all') {
            row.style.display = '';
        } else {
            const statusCell = row.cells[4];
            if (statusCell && statusCell.textContent.toLowerCase().includes(filter)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });
}
</script>
{% endblock %}
